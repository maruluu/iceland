<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å†°å³¶12å¤©è¡Œç¨‹</title>
    <link rel="stylesheet" href="./style.css"/>
</head>
<body>
    <div class="page-container">
        <header><h1>ä¾†å»å†°å³¶çœ‹æ¥µå…‰11å¤©è¡Œç¨‹</h1></header>
        <div class="important-notes">
            <ul>
                <li>é»æ“Šæ™¯é»åç¨±å¯åœ¨ Google åœ°åœ–ä¸­æ‰“é–‹è©²åœ°é»ã€‚</li>
                <li>é»æ“Šè¡Œç¨‹ä¸­çš„å°åœ–ç‰‡å¯æŸ¥çœ‹å¤§åœ–ã€‚</li>
            </ul>
        </div>
        <div class="tab-container" id="tabContainer"></div>
        <div id="tabContentContainer"></div>
    </div>
    <!-- Image Modal -->
    <div id="myImageModal" class="image-modal">
        <span class="image-modal-close">&times;</span>
        <img class="image-modal-content" id="imgModalSrc" alt="æ”¾å¤§åœ–ç‰‡">
    </div>

    <script>
        // --- é¡åˆ¥æ¨™ç±¤è‰²å½© ---
        function getCategoryClass(category) {
            if (!category) return 'cat-default';
            if (category.includes('ğŸŒŸ')) return 'cat-journey-overview';
            if (category.includes('âœˆï¸')) return 'cat-flight-segment';
            if (category.includes('â³')) return 'cat-layover-time';
            if (category.includes('ğŸ')) return 'cat-arrival-next-leg';
            if (category.includes('ğŸš—')) return 'cat-mov';
            if (category.includes('ğŸ§')) return 'cat-eat';
            if (category.includes('â›±') || category.includes('ğŸ‘')) return 'cat-see';
            if (category.includes('ğŸ¡')) return 'cat-stay';
            if (category.includes('ğŸ­')) return 'cat-act';
            return 'cat-default';
        }
        // --- ç¸®åœ– Modal ---
        const modal = document.getElementById("myImageModal");
        const modalImg = document.getElementById("imgModalSrc");
        document.querySelector(".image-modal-close").onclick = () => { modal.style.display = "none"; }
        window.onclick = (e) => { if (e.target === modal) modal.style.display = "none"; }
        document.addEventListener('keydown', (e) => { if (e.key === "Escape" && modal.style.display === "block") modal.style.display = "none"; });
        function openImageModal(src) {
            modal.style.display = "block";
            modalImg.src = src;
        }
        // --- è¡Œç¨‹å…§å®¹ç”¢ç”Ÿ ---
        function generateDayHtml(dayData, dayIndex) {
            if (dayIndex === 0 && dayData.isSpecialDay === "departure") {
                return `<h2>${dayData.dayTitle}</h2>
                <table class="itinerary-table"><thead><tr><th>é …ç›®</th><th>èªªæ˜</th></tr></thead>
                <tbody>${dayData.items.map(item =>
                    `<tr><td>${item.åœ°é» || ''}</td><td>${item.æè¿° || ''}</td></tr>`
                ).join('')}</tbody></table>
                <p style="text-align:center; color:#555;">å•Ÿç¨‹æ—¥ï¼Œå°ˆæ³¨é£›è¡Œï¼Œæœ¬åœ°åœ–ç„¡æ™¯é»é¡¯ç¤ºã€‚</p>`;
            }
            let itemsHtml = '<ul class="itinerary-list">';
            dayData.items.forEach(item => {
                const categoryClass = getCategoryClass(item.é¡åˆ¥);
                const isDriving = item.é¡åˆ¥?.includes('ğŸš—') && item.åœ°é»?.startsWith("ç§»å‹•:");
                if (isDriving) {
                    itemsHtml += `<li class="driving-info">${item.åœ°é».replace("ç§»å‹•:", "").trim()}</li>`;
                    return;
                }
                // æ™¯é»/åƒå–/æ´»å‹•/ä½å®¿å«ç…§ç‰‡
                if (['cat-see','cat-eat','cat-act','cat-stay'].includes(categoryClass) && item.ç…§ç‰‡) {
                    const photoUrl = String(item.ç…§ç‰‡).split(',')[0].trim();
                    itemsHtml += `<li class="itinerary-item"><div style="display:flex;align-items:flex-start;gap:1rem;">
                        <div><img src="${photoUrl}" alt="${item.åœ°é»} ç¸®åœ–" class="item-photo-thumbnail" onclick="openImageModal('${photoUrl}')"></div>
                        <div style="flex:1;">
                            <span class="item-category ${categoryClass}">${item.é¡åˆ¥||'è³‡è¨Š'}</span>
                            ${item.lat && item.lng ? `<strong><a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.mapLabel||item.åœ°é»)}&ll=${item.lat},${item.lng}" target="_blank">${item.mapPriority ? item.mapPriority+'. ' : ''}${item.åœ°é»}</a></strong>` : `<strong>${item.åœ°é»}</strong>`}
                            ${item.æè¿° ? `<div class="item-description">${item.æè¿°}</div>` : ''}
                            ${item.å…‹æœ— ? `<div class="item-description">è²»ç”¨ï¼šç´„ ${item.å…‹æœ—} ISK</div>` : ''}
                            ${item.å°å¹£ ? `<div class="item-description">è²»ç”¨åƒè€ƒï¼šç´„ ${item.å°å¹£} TWD</div>` : ''}
                            ${item.ç‡Ÿæ¥­æ™‚é–“ ? `<div class="item-description"><span style="color:#005792;font-weight:bold;">ç‡Ÿæ¥­æ™‚é–“ï¼š</span>${item.ç‡Ÿæ¥­æ™‚é–“}</div>` : ''}
                            ${item.ç¶²å€ ? `<div class="item-url"><a href="${item.ç¶²å€}" target="_blank">ç›¸é—œé€£çµ</a></div>` : ''}
                        </div></div></li>`;
                } else {
                    itemsHtml += `<li class="itinerary-item">
                        <span class="item-category ${categoryClass}">${item.é¡åˆ¥||'è³‡è¨Š'}</span>
                        ${item.lat && item.lng ? `<strong><a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.mapLabel||item.åœ°é»)}&ll=${item.lat},${item.lng}" target="_blank">${item.mapPriority ? item.mapPriority+'. ' : ''}${item.åœ°é»}</a></strong>` : `<strong>${item.åœ°é»}</strong>`}
                        ${item.æè¿° ? `<div class="item-description">${item.æè¿°}</div>` : ''}
                        ${item.å…‹æœ— ? `<div class="item-description">è²»ç”¨ï¼šç´„ ${item.å…‹æœ—} ISK</div>` : ''}
                        ${item.å°å¹£ ? `<div class="item-description">è²»ç”¨åƒè€ƒï¼šç´„ ${item.å°å¹£} TWD</div>` : ''}
                        ${item.ç¶²å€ ? `<div class="item-url"><a href="${item.ç¶²å€}" target="_blank">ç›¸é—œé€£çµ</a></div>` : ''}
                    </li>`;
                }
            });
            itemsHtml += '</ul>';
            // åœ°åœ–é¡¯ç¤º
            const hasMap = dayData.mapCenter || (dayData.items && dayData.items.some(it => it.lat && it.lng && it.mapLabel && typeof it.mapPriority === 'number'));
            return `<h2>${dayData.dayTitle}</h2>${itemsHtml}${hasMap ? `<div id="mapDay${dayIndex}" class="map-container"></div>` : ''}`;
        }
        // --- Google Maps åˆå§‹åŒ– ---
        function displayRoute(mapId, locations, mapCenter, mapZoom) {
            const el = document.getElementById(mapId);
            if (!el) return;
            if (!google?.maps) return el.innerHTML = "<p style='text-align:center;padding-top:20px;'>åœ°åœ–æœå‹™è¼‰å…¥ä¸­...</p>";
            const map = new google.maps.Map(el, { zoom: mapZoom || 8, center: mapCenter || locations[0]?.location || { lat: 64.9631, lng: -19.0208 } });
            if (locations.length === 1) return new google.maps.Marker({ position: locations[0].location, map, label: locations[0].title, title: locations[0].title });
            if (!locations.length) return;
            const directionsService = new google.maps.DirectionsService();
            const directionsRenderer = new google.maps.DirectionsRenderer({ map, suppressMarkers: true });
            const waypoints = locations.slice(1, -1).map(loc => ({ location: loc.location, stopover: true }));
            directionsService.route({
                origin: locations[0].location,
                destination: locations[locations.length - 1].location,
                waypoints, optimizeWaypoints: true, travelMode: google.maps.TravelMode.DRIVING
            }, (result, status) => {
                if (status === 'OK') {
                    directionsRenderer.setDirections(result);
                    locations.forEach((loc, i) => new google.maps.Marker({ position: loc.location, map, label: `${i+1}`, title: loc.title }));
                } else {
                    el.innerHTML = `<p style='text-align:center; padding-top:20px;'>åœ°åœ–è·¯ç·šè¼‰å…¥å¤±æ•— (${status})ã€‚</p>`;
                    locations.forEach((loc, i) => new google.maps.Marker({ position: loc.location, map, label: `${i+1}`, title: loc.title }));
                }
            });
        }
        // --- Tab åˆ‡æ› ---
        function openDayTab(dayIdx) {
            document.querySelectorAll('.tab-button').forEach((btn,i) => btn.classList.toggle('active', i===dayIdx));
            document.querySelectorAll('.tab-content').forEach((ctn,i) => ctn.classList.toggle('active', i===dayIdx));
            localStorage.setItem('activeItineraryTabIndex', dayIdx);
            // Google Map
            const dayData = window.allItineraryData[dayIdx];
            const mapId = `mapDay${dayIdx}`;
            if ((dayData.mapCenter || (dayData.items && dayData.items.some(it => it.lat && it.lng && it.mapLabel && typeof it.mapPriority === 'number'))) && !window.mapsInitialized?.[mapId]) {
                const locations = (dayData.items||[]).filter(it => it.lat && it.lng && it.mapLabel && typeof it.mapPriority === 'number')
                    .sort((a,b)=>a.mapPriority-b.mapPriority)
                    .map(it => ({ location: { lat: it.lat, lng: it.lng }, title: it.mapLabel }));
                if (window.google?.maps) displayRoute(mapId, locations, dayData.mapCenter, dayData.mapZoom);
                window.mapsInitialized = window.mapsInitialized || {};
                window.mapsInitialized[mapId] = true;
            }
        }
        // --- åˆå§‹åŒ–é é¢ ---
        function initPage() {
            const tabCtn = document.getElementById('tabContainer');
            const tabContentCtn = document.getElementById('tabContentContainer');
            window.allItineraryData.forEach((day, i) => {
                const btn = document.createElement('a');
                btn.className = 'tab-button'; btn.textContent = day.dayGroup; btn.href = `#day${i}`;
                btn.onclick = e => { e.preventDefault(); window.location.hash = `#day${i}`; openDayTab(i);}
                tabCtn.appendChild(btn);

                const ctn = document.createElement('div');
                ctn.className = 'tab-content'; ctn.id = `dayContent${i}`;
                if (day.isSpecialDay === "departure") ctn.classList.add('departure-day-content');
                ctn.innerHTML = generateDayHtml(day, i);
                tabContentCtn.appendChild(ctn);
            });
            // ä¾hashæˆ–localStorageé¸å•Ÿå§‹tab
            let idx = 0, hash = window.location.hash;
            if (hash.startsWith('#day')) { let hi = parseInt(hash.replace('#day',''),10); if (!isNaN(hi)) idx = hi; }
            else { let lidx = parseInt(localStorage.getItem('activeItineraryTabIndex'),10); if (!isNaN(lidx)) idx = lidx;}
            openDayTab(idx);
            window.addEventListener('hashchange', () => {
                let hi = parseInt(window.location.hash.replace('#day',''),10);
                if (!isNaN(hi)) openDayTab(hi);
            });
        }
    </script>
    <script type="module">
        const googleMapsApiKey = import.meta.env.VITE_GOOGLE_MAPS_API_KEY
        console.log('è¼‰å…¥ Google Maps API...', googleMapsApiKey);
        function loadGoogleMapsApi() {
            if (!googleMapsApiKey || googleMapsApiKey.startsWith('__')) {
                console.error('Google Maps API é‡‘é‘°æœªè¨­å®š');
                return;
            }
            let script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${googleMapsApiKey}&callback=initPage&libraries=routes`;
            script.async = true; script.defer = true;
            document.body.appendChild(script);
        }
        import { allItineraryData } from './config.js';
        window.allItineraryData = allItineraryData;
        // Day 0 - Updated with flight info
       


        window.addEventListener('DOMContentLoaded', loadGoogleMapsApi);
    </script>
</body>
</html>
